name: release-2-build-upload

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to build and upload to (e.g., desktop-v1.2.3)
        required: true
      linux:
        description: Linux - build and upload
        type: boolean
        default: true
      windows:
        description: Windows - build and upload
        type: boolean
        default: true
      macos:
        description: macOS - build and upload
        type: boolean
        default: true

permissions:
  contents: write

env:
  VITE_POSTHOG_API_KEY: ${{ vars.VITE_POSTHOG_API_KEY }}
  VITE_POSTHOG_API_HOST: ${{ vars.VITE_POSTHOG_API_HOST }}

jobs:
  linux:
    if: ${{ inputs.linux }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          lfs: true
      - name: Setup and build
        uses: ./.github/actions/setup-build
      - name: Package + upload (linux)
        uses: ./.github/actions/package-upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ inputs.tag }}
          platform: linux

  windows:
    if: ${{ inputs.windows }}
    runs-on: windows-latest
    environment: production
    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          lfs: true
      - name: Setup and build
        uses: ./.github/actions/setup-build
      - name: Package + upload (windows)
        uses: ./.github/actions/package-upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ inputs.tag }}
          platform: windows

  macos:
    if: ${{ inputs.macos }}
    runs-on: macos-latest
    environment: production
    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          lfs: true
      - name: Setup and build
        uses: ./.github/actions/setup-build

      - name: Setup macOS certificate
        env:
          PROD_MACOS_CERTIFICATE: ${{ secrets.PROD_MACOS_CERTIFICATE }}
          PROD_MACOS_CERTIFICATE_PWD: ${{ secrets.PROD_MACOS_CERTIFICATE_PWD }}
          PROD_MACOS_CERTIFICATE_NAME: ${{ secrets.PROD_MACOS_CERTIFICATE_NAME }}
          PROD_MACOS_CI_KEYCHAIN_PWD: ${{ secrets.PROD_MACOS_CI_KEYCHAIN_PWD }}
        run: ./packages/desktop/scripts/setup-macos-signing.sh

      - name: Package + upload (macos)
        uses: ./.github/actions/package-upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ vars.APPLE_ID }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          CSC_IDENTITY_AUTO_DISCOVERY: true
        with:
          tag: ${{ inputs.tag }}
          platform: macos