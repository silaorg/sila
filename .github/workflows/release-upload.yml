name: Release - Upload Win/Linux to Draft

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to build and upload to (e.g., v1.2.3)
        required: true

permissions:
  contents: write

jobs:
  upload_assets:
    name: Build and upload Windows/Linux assets to draft release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: win32

    steps:
      - name: Checkout at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Package Linux artifacts
        if: runner.os == 'Linux'
        run: |
          cd packages/desktop
          npm run package:linux

      - name: Package Windows artifacts
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd packages/desktop
          npm run package:win

      - name: Ensure draft release exists
        if: runner.os == 'Linux'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ inputs.tag }}"
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release $TAG_NAME exists; keeping draft=true"
            gh release edit "$TAG_NAME" --draft=true --prerelease=false --verify-tag
          else
            echo "Draft release $TAG_NAME does not exist; creating"
            gh release create "$TAG_NAME" --draft --verify-tag --generate-notes
          fi

      - name: Upload Linux artifacts to draft release
        if: runner.os == 'Linux'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG_NAME="${{ inputs.tag }}"
          ASSET_GLOBS="packages/desktop/dist/*.AppImage packages/desktop/dist/*.deb packages/desktop/dist/*.rpm packages/desktop/dist/*latest*.yml packages/desktop/dist/*-linux*.yml"
          shopt -s nullglob
          FILES=()
          for g in $ASSET_GLOBS; do
            for f in $g; do FILES+=("$f"); done
          done
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No Linux artifacts to upload" >&2
            exit 0
          fi
          echo "Uploading ${#FILES[@]} Linux artifacts to $TAG_NAME"
          gh release upload "$TAG_NAME" "${FILES[@]}" --clobber

      - name: Upload Windows artifacts to draft release
        if: runner.os == 'Windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tagName = '${{ inputs.tag }}'
          $patterns = @(
            'packages/desktop/dist/*.exe',
            'packages/desktop/dist/*.msi',
            'packages/desktop/dist/*latest*.yml',
            'packages/desktop/dist/*-win*.yml'
          )
          $files = @()
          foreach ($p in $patterns) { $files += Get-ChildItem -Path $p -ErrorAction SilentlyContinue | Select-Object -Expand FullName }
          if ($files.Count -eq 0) {
            Write-Host 'No Windows artifacts to upload'
            exit 0
          }
          Write-Host ("Uploading {0} Windows artifacts to {1}" -f $files.Count, $tagName)
          gh release upload $tagName $files --clobber

