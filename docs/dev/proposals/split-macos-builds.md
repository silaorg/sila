# Proposal: Build macOS locally, keep Linux/Windows on CI

## Goal
Reduce GitHub Actions cost/time by moving macOS builds local. Keep CI for Windows/Linux. Use a single GitHub Release per version tag.

## Workflow (clear separation)
- Step 1 — Create release from tag (draft only)
  - Trigger: push tag `v*`.
  - Action: create GitHub Release as `draft=true` with autogenerated notes. No binaries yet.
  - Rationale: clients must not see/fetch incomplete releases.
- Step 2 — Upload builds to that draft release
  - CI uploads Windows/Linux installers to the existing draft release.
  - Local (macOS) publishes DMGs to the same draft release.
- Step 3 — Finalize (required)
  - When all assets are attached and verified, set `draft=false` to publish the release.
  - Only then will clients see and auto-update to this version.

## Plan
- CI: split into two workflows
  - `release-create.yml`: on tag push, create draft release with notes.
  - `release-upload.yml`: triggered manually with a tag input, or on `release.edited` (if desired), to build and upload Windows/Linux only to the draft release.
  - `release-finalize.yml`: manual job (or automated if all uploads succeed) that flips the release to `draft=false`.
- Local mac: build and publish with `electron-builder` to the same draft release.
  - Requirements: `GH_TOKEN`, `APPLE_ID`, `APPLE_ID_PASS` (and optionally `CSC_LINK`, `CSC_KEY_PASSWORD`).
  - Flow: tag push → Step 1 creates draft → Step 2 CI uploads Win/Linux → local mac publish appends DMGs → Step 3 finalize.

## Commands (reference)
- One-off local publish to draft release:
```bash
( set -a; [ -f packages/desktop/.env ] && source packages/desktop/.env; set +a; ) \
  && npm -w packages/desktop run build:publish
```
- Alternative upload with GitHub CLI if needed:
```bash
gh release upload vX.Y.Z packages/desktop/dist/*.dmg --clobber
```
- Finalize (publish) the draft release:
```bash
gh release edit vX.Y.Z --draft=false
```

## Risks
- Arch: `x64` from Apple Silicon may need Rosetta; consider per-arch builds.
- Duplicates: avoid re-upload collisions; allow overwrite when intentional.
- Secrets: manage Apple/signing credentials securely on the dev machine.

## Rollout
1) Add `release-create.yml` (tag → draft release).
2) Add/adjust `release-upload.yml` (build+upload Win/Linux to draft release).
3) Push a test tag, verify draft release creation.
4) Confirm CI assets attach to the draft.
5) Run local mac publish and verify DMGs attach.
6) Run `release-finalize.yml` (or `gh release edit ... --draft=false`) to publish.

## CI workflows
- Create draft: `release-1-draft` (trigger: push tag `v*`).
- Upload Win/Linux: `release-2-build-upload` (manual: input `tag`).
- Finalize: `release-3-finalize` (manual: input `tag`).

### Quick test (GitHub)
1) Create a test tag and push:
```bash
git tag v0.0.0-test
git push origin v0.0.0-test
```
This triggers "release-1-draft" and should create a draft release `v0.0.0-test`.

2) Manually run upload (Win/Linux):
```bash
gh workflow run "release-2-build-upload" -f tag=v0.0.0-test
```

3) Build macOS locally and upload DMGs to the same draft (from repo root):
```bash
( set -a; [ -f packages/desktop/.env ] && source packages/desktop/.env; set +a; ) \
  && npm -w packages/desktop run build \
  && gh release upload v0.0.0-test packages/desktop/dist/*.dmg --clobber
```

4) Finalize the release (publish):
```bash
gh workflow run "release-3-finalize" -f tag=v0.0.0-test
# or
gh release edit v0.0.0-test --draft=false
```
